<html>
  <head>
    <title>Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script type="importmap">
      {
        "imports": {
          "qrious": "https://cdn.skypack.dev/qrious"
        }
      }
    </script>
  </head>
  <body>
    <h1>
      QRSocket
      <small>Sorry, not sorry</small>
    </h1>

    <main>
      <form class="chat">
        <ol class="messageList"></ol>
        <div class="messageInput">
          <input type="text" name="message" />
          <input type="submit" value="send" />
        </div>
      </form>
      <details>
        <summary>Debug</summary>
        <button id="add50">50 x debug</button>
      </details>
    </main>

    <script type="module">
      import { QRSocket } from "./QRSocket.js";

      const sock = new QRSocket();

      document.body.appendChild(sock.element);

      sock.start();

      sock.addEventListener("message", (message) => {
        append(message.data, "inbound");
      });

      const messageList = document.querySelector("ol.messageList");

      function append(message, classname) {
        const li = document.createElement("li");
        li.innerText = message;
        li.className = classname;
        messageList.appendChild(li);

        // out.innerText += message + "\n";
        messageList.scrollTo({
          top: messageList.scrollHeight,
          behavior: "smooth",
        });
      }

      let tt = 0;
      function add50() {
        for (let i = 0; i < 50; i++) {
          const message = `${Math.random()
            .toString(32)
            .slice(3)} (test message #${tt++})`;

          append(message, "outbound");
          sock.send(message);
        }
      }
      document.querySelector("#add50").addEventListener("click", add50);

      const f = document.querySelector("form.chat");

      f.addEventListener("submit", (e) => {
        e.preventDefault();

        const d = new FormData(f);
        const message = d.get("message");
        sock.send(message);
        append(message, "outbound");

        f.reset();
      });
    </script>
  </body>
</html>
